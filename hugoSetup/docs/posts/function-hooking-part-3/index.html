<!DOCTYPE html>
<html lang="en">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    
    <link rel="canonical" href="/posts/function-hooking-part-3/">
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.68.3" />

    
    
    

<title>Function Hooking Part 3 - Frida • Lum8rjack</title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Function Hooking Part 3 - Frida"/>
<meta name="twitter:description" content="This post will wrap up the function hooking series. You can view the previous posts here:
 Function Hooking Part 1 - Test Program Function Hooking Part 2 - Password Safe  In this post I will show another method you can use to hook functions. Instead of writing an injector and DLL in C&#43;&#43;, I will be using a tool called Frida that allows you to do the same with Python and JavaScript."/>

<meta property="og:title" content="Function Hooking Part 3 - Frida" />
<meta property="og:description" content="This post will wrap up the function hooking series. You can view the previous posts here:
 Function Hooking Part 1 - Test Program Function Hooking Part 2 - Password Safe  In this post I will show another method you can use to hook functions. Instead of writing an injector and DLL in C&#43;&#43;, I will be using a tool called Frida that allows you to do the same with Python and JavaScript." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/function-hooking-part-3/" />
<meta property="article:published_time" content="2022-02-06T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-02-06T00:00:00+00:00" /><meta property="og:site_name" content="Lum8rjack" />


    


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">








<link rel="stylesheet" href="/scss/hyde-hyde.d7131289fa9e8cd0d2d4afc262d1f13af6ce894f665e0ca215389bcfa359fbae.css" integrity="sha256-1xMSifqejNDS1K/CYtHxOvbOiU9mXgyiFTibz6NZ&#43;64=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
    

</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="/">
        
          Lum8rjack
        
        </a>
      </span>
      
        
        
        
        <div class="author-image">
          <img src="/img/tree.png" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
      
      
      <p class="site__description">
         red teamer and infosec researcher 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">Lum8rjack</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/about/">
						<span>About</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/posts/">
						<span>Posts</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/portfolio/">
						<span>Projects</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/lum8rjack" rel="me"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="https://github.com/lum8rjack" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	<a href="https://linkedin.com/in/muellerclint" rel="me"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
	
	
	
	
	
</section>

      </div>
    </div>
    

<div class="builtwith">
Built with <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
</div>


  </div>
</div>

        <div class="content container">
            
    
<article>
  <header>
    <h1>Function Hooking Part 3 - Frida</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Feb 6, 2022
    
    
    
      
      
          in
          
          
              <a class="badge badge-category" href="/categories/function-hooking">FUNCTION-HOOKING</a>
              
          
      
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/windows">windows</a>
           
      
          <a class="badge badge-tag" href="/tags/frida">frida</a>
           
      
          <a class="badge badge-tag" href="/tags/password-manager">password manager</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 5 min read
</div>


  </header>
  
  
  <div class="post">
    <p>This post will wrap up the function hooking series. You can view the previous posts here:</p>
<ul>
<li><a href="/posts/function-hooking-part-1/">Function Hooking Part 1 - Test Program</a></li>
<li><a href="/posts/function-hooking-part-2/">Function Hooking Part 2 - Password Safe</a></li>
</ul>
<p>In this post I will show another method you can use to hook functions. Instead of writing an injector and DLL in C++, I will be using a tool called Frida that allows you to do the same with Python and JavaScript.</p>
<h2 id="what-is-frida">What Is Frida?</h2>
<p><a href="https://frida.re">Frida</a> is a &ldquo;Dynamic instrumentation toolkit for developers, reverse-engineers, and security researchers.&rdquo; Frida lets you inject snippets of JavaScript into native apps on Windows, macOS, GNU/Linux, iOS, Android, and QNX.</p>
<h2 id="revisiting-password-safe">Revisiting Password Safe</h2>
<p>If you remember from the previous post, I identified the Password Safe function that checks if the provided password is correct in order to unlock the safe. A function signature was created and added to the C++ code to compile a DLL that could intercept the password when it was submitted.</p>
<p>Since then, I created a Ghidra script called <a href="https://github.com/lum8rjack/GhidraHelp">CreateFunctionSignature.py</a> that takes the function name and creates the signature for you. The output provides multiple formats of the bytes to be used with different tools or programing languages. The example below uses the script to identify the same signature for the CheckPassKey function in pwsafe.</p>
<pre><code>CreateFunctionSignature.py&gt; Running...
The currently loaded program is: 'pwsafe.exe'
Creating signature for the function: CheckPassKey
Function: CheckPassKey @ 0x00746cb0
Signature length: 28
Signature: 558bec83ec10b8cccccccc8945f08945f48945f88945fc8b450c8b48
Signature: [0x55, 0x8b, 0xec, 0x83, 0xec, 0x10, 0xb8, 0xcc, 0xcc, 0xcc, 0xcc, 0x89, 0x45, 0xf0, 0x89, 0x45, 0xf4, 0x89, 0x45, 0xf8, 0x89, 0x45, 0xfc, 0x8b, 0x45, 0x0c, 0x8b, 0x48]
Signature: 55 8b ec 83 ec 10 b8 cc cc cc cc 89 45 f0 89 45 f4 89 45 f8 89 45 fc 8b 45 0c 8b 48 
Signature: \x55\x8b\xec\x83\xec\x10\xb8\xcc\xcc\xcc\xcc\x89\x45\xf0\x89\x45\xf4\x89\x45\xf8\x89\x45\xfc\x8b\x45\x0c\x8b\x48
Mask: xxxxxxxxxxxxxxxxxxxxxxxxxxxx
CreateFunctionSignature.py&gt; Finished!
</code></pre><h2 id="frida-js">Frida JS</h2>
<p>The JavaScript code below is similar to the DLL we previously created. The code will be injected into the application and will intercept the CheckPassKey function based on the function signature. The code will store the passkey the user submitted, along with the path to the database, and then output the results to the console if the passkey was correct.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#75715e">// Find the module for the program itself, always at index 0:
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">m</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Process</span>.<span style="color:#a6e22e">enumerateModules</span>()[<span style="color:#ae81ff">0</span>];

<span style="color:#75715e">// The pattern that you are interested in:
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">pattern</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;55 8b ec 83 ec 10 b8 cc cc cc cc 89 45 f0 89 45 f4 89 45 f8 89 45 fc 8b 45 0c 8b 48&#39;</span>;

<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;[+] Scanning started&#34;</span>);
<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;[+] Base address: &#34;</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">base</span>);
<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;[+] Module size:  &#34;</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">size</span>);

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">doit</span>(<span style="color:#a6e22e">pointer</span>) {
	<span style="color:#a6e22e">Interceptor</span>.<span style="color:#a6e22e">attach</span>(<span style="color:#a6e22e">pointer</span>,
	{
		<span style="color:#75715e">// Arguments we know from the source code of the application
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//args: (const StringX &amp;filename, const StringX &amp;passkey, VERSION &amp;version)
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">onEnter</span>(<span style="color:#a6e22e">args</span>) {
			<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">arg0</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Memory</span>.<span style="color:#a6e22e">readUtf16String</span>(<span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">readPointer</span>()); <span style="color:#75715e">// stores the path to the database
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">arg1</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Memory</span>.<span style="color:#a6e22e">readUtf16String</span>(<span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">1</span>].<span style="color:#a6e22e">readPointer</span>()); <span style="color:#75715e">// stores the password
</span><span style="color:#75715e"></span>		},

		<span style="color:#75715e">//returns an int: 0 correct and 5 is incorrect passkey
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">onLeave</span>(<span style="color:#a6e22e">retval</span>) {
			<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">retval</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
				<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;[+] Database:  &#34;</span> <span style="color:#f92672">+</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">arg0</span>);
				<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;[+] Password:  &#34;</span> <span style="color:#f92672">+</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">arg1</span>);
			}
		}
	});
}
  
<span style="color:#a6e22e">Memory</span>.<span style="color:#a6e22e">scan</span>(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">base</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">size</span>, <span style="color:#a6e22e">pattern</span>, {
  <span style="color:#a6e22e">onMatch</span>(<span style="color:#a6e22e">address</span>, <span style="color:#a6e22e">size</span>) {
    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#39;[+] Memory.scan() found match at&#39;</span>, <span style="color:#a6e22e">address</span>, <span style="color:#e6db74">&#39;with size&#39;</span>, <span style="color:#a6e22e">size</span>);
	<span style="color:#a6e22e">doit</span>(<span style="color:#a6e22e">address</span>);
    <span style="color:#75715e">// Optionally stop scanning early:
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;stop&#39;</span>;
  },
  <span style="color:#a6e22e">onComplete</span>() {
    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#39;[+] Memory.scan() complete&#39;</span>);
  }
});
</code></pre></td></tr></table>
</div>
</div><p>I won&rsquo;t explain every line of the JavaScript code, but below details a few of the main focus areas:</p>
<ul>
<li><strong>Line 31:</strong> Scan the application to find where the function is we want to hook</li>
<li><strong>Line 32-34:</strong> If there is a match, the address is sent to the &lsquo;doit&rsquo; function</li>
<li><strong>Line 12:</strong> Attach to the function</li>
<li><strong>Line 16-19:</strong> Intercept the arguments to the function and save them as variables</li>
<li><strong>Line 22-27:</strong> If the passkey was correct, the passkey and database location are output to the console</li>
</ul>
<h2 id="execution">Execution</h2>
<p>The Python code is similar to the injector I created in the first post and is used to load and invoke Frida. Frida will take the JavaScript code and inject it into the application. The Python <a href="https://github.com/lum8rjack/FunctionHooking/blob/main/Part3/fridaStart.py">script</a> is pretty simple and can be used for other projects as well. It takes two arguments, the JavaScript code to inject and the PID or name of the application we will be injecting into.</p>
<pre><code>&gt; python fridaStart.py --script CheckPassKey.js --pid 6056
Attached to PID: 6056
[+] Scanning started
[+] Base address:  0xb10000
[+] Module size:   8712192
[+] Memory.scan() found match at 0xe56cb0 with size 28
[+] Memory.scan() complete
[+] Database:  C:\Users\IEUser\Documents\My Safes\pwsafe.psafe3
[+] Password:  password123
</code></pre><p>You can see from the output above, that the JavaScript first finds the base address of the application and scans for the function. Once the function address is identified, it intercepts the argements and outputs them to the screen. Instead of outputing the results to the console, I could update the JavaScript code in order to send the results back to Python. This would allow me to easily save the details to a file or perform additional analysis.</p>
<h2 id="wrap-up">Wrap-Up</h2>
<p>While this method of using Frida may not be as stealthy to implement in a penetration test or red team engagement, it does make it easier to create quick POCs. I find it much quicker to write the logic in Python and use the Frida Javascript API instead of C++ when first analyzing an application. In the References section below, I included a few addtional links to blogs where others have used Frida for hacking games or fuzzing.</p>
<p>Example code <a href="https://github.com/lum8rjack/FunctionHooking">here</a>.</p>
<h2 id="references--acknowledgements">References / Acknowledgements</h2>
<ul>
<li><a href="https://frida.re/">https://frida.re/</a></li>
<li><a href="https://learnfrida.info/">https://learnfrida.info/</a></li>
<li><a href="https://www.amazon.com/Beginning-Frida-Learning-Android-JavaScript-ebook/dp/B094ZNR1MV/ref=sr_1_1?crid=21JQOO7K2D218&amp;keywords=frida+reverse+engineering+book&amp;qid=1643771486&amp;sprefix=frida+reverse+engineeringbook%2Caps%2C74&amp;sr=8-1">https://www.amazon.com/Beginning-Frida-Learning-Android-JavaScript-ebook/dp/B094ZNR1MV/ref=sr_1_1?crid=21JQOO7K2D218&amp;keywords=frida+reverse+engineering+book&amp;qid=1643771486&amp;sprefix=frida+reverse+engineeringbook%2Caps%2C74&amp;sr=8-1</a></li>
<li><a href="https://bananamafia.dev/post/frida-fuzz/">https://bananamafia.dev/post/frida-fuzz/</a></li>
<li><a href="https://x-c3ll.github.io/posts/Frida-Pwn-Adventure-3/">https://x-c3ll.github.io/posts/Frida-Pwn-Adventure-3/</a></li>
<li><a href="https://github.com/lum8rjack/GhidraHelp">https://github.com/lum8rjack/GhidraHelp</a></li>
<li><a href="https://github.com/lum8rjack/FunctionHooking">https://github.com/lum8rjack/FunctionHooking</a></li>
</ul>

  </div>
  


  

  
    


</article>


        </div>
        
    

  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-176789551-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


<script defer src="https://use.fontawesome.com/releases/v5.12.1/js/all.js" integrity="sha384-ZbbbT1gw3joYkKRqh0kWyRp32UAvdqkpbLedQJSlnI8iLQcFVxaGyrOgOJiDQTTR" crossorigin="anonymous"></script>


    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
        
    <script type="text/javascript">
        
        hljs.initHighlightingOnLoad();
    </script>
    



    



    </body>
</html>
